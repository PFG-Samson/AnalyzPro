{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-md-8">
            <h1>üì• Download Progress</h1>
            <p class="text-muted">Real-time STAC imagery download tracking</p>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge bg-info" id="download-status">Initializing...</span>
        </div>
    </div>

    <!-- Main Progress Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <!-- Overall Progress -->
            <div class="mb-4">
                <div class="d-flex justify-content-between mb-2">
                    <label class="fw-bold">Overall Progress</label>
                    <span id="progress-percent" class="badge bg-primary">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>

            <!-- Status Information -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="stat-item">
                        <small class="text-muted">Status</small>
                        <p class="fs-6 fw-bold" id="status-text">Initializing...</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-item">
                        <small class="text-muted">Total Files</small>
                        <p class="fs-6 fw-bold" id="file-count">0</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-item">
                        <small class="text-muted">Downloaded</small>
                        <p class="fs-6 fw-bold" id="downloaded-size">0 MB</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-item">
                        <small class="text-muted">Speed</small>
                        <p class="fs-6 fw-bold" id="download-speed">-- MB/s</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Errors Alert -->
    <div id="errors-container"></div>

    <!-- Scenes Download List -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light border-bottom p-3">
            <h5 class="mb-0">üì¶ Scenes</h5>
        </div>
        <div class="card-body p-0">
            <div id="scenes-list" class="list-group list-group-flush">
                <div class="list-group-item text-muted text-center py-4">
                    Loading scene information...
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Options (shown when download completes) -->
    <div id="storage-options" class="card border-0 shadow-sm d-none">
        <div class="card-header bg-light border-bottom p-3">
            <h5 class="mb-0">üíæ What to do with downloaded imagery?</h5>
        </div>
        <div class="card-body p-4">
            <div class="row g-3">
                <!-- Keep Permanently -->
                <div class="col-md-6">
                    <div class="option-card p-3 border rounded cursor-pointer" onclick="selectStorage('keep')">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="storage" id="keep-opt" value="keep">
                            <label class="form-check-label w-100" for="keep-opt">
                                <strong>üìå Keep Permanently</strong>
                                <p class="text-muted small mt-1 mb-0">
                                    Store imagery in permanent library for future use. Recommended for archival or repeated analysis.
                                </p>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Analyze & Delete -->
                <div class="col-md-6">
                    <div class="option-card p-3 border rounded cursor-pointer" onclick="selectStorage('analyze')">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="storage" id="analyze-opt" value="analyze">
                            <label class="form-check-label w-100" for="analyze-opt">
                                <strong>üîç Analyze & Clean Up</strong>
                                <p class="text-muted small mt-1 mb-0">
                                    Proceed with analysis, then delete temporary files after 24 hours to save space.
                                </p>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Delete Now -->
                <div class="col-md-6">
                    <div class="option-card p-3 border rounded cursor-pointer" onclick="selectStorage('delete')">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="storage" id="delete-opt" value="delete">
                            <label class="form-check-label w-100" for="delete-opt">
                                <strong>üóëÔ∏è Delete Now</strong>
                                <p class="text-muted small mt-1 mb-0">
                                    Don't keep the imagery. Release storage immediately. Can't be recovered.
                                </p>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkbox for auto-analysis -->
            <div class="mt-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="auto-analyze-check" checked>
                    <label class="form-check-label" for="auto-analyze-check">
                        <strong>Automatically start analysis after storage decision</strong>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4">
                <button type="button" class="btn btn-primary btn-lg" id="confirm-storage-btn" onclick="confirmStorage()">
                    <i class="fas fa-check-circle"></i> Confirm & Continue
                </button>
                <button type="button" class="btn btn-secondary btn-lg" onclick="goHome()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner (during download) -->
    <div id="loading-spinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Downloading...</span>
        </div>
        <p class="mt-3 text-muted">Downloading satellite imagery from STAC catalog...</p>
    </div>
</div>

<!-- Styles -->
<style>
    .stat-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .option-card {
        background: #fff;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .option-card:hover {
        background: #f8f9fa;
        border-color: #0d6efd !important;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .option-card input:checked ~ label {
        color: #0d6efd;
        font-weight: 600;
    }

    .scene-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        transition: background 0.3s ease;
    }

    .scene-item:last-child {
        border-bottom: none;
    }

    .scene-item:hover {
        background: #f8f9fa;
    }

    .scene-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .scene-details {
        flex: 1;
    }

    .scene-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .scene-metadata {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .scene-progress {
        width: 100px;
        margin-left: 1rem;
    }

    .alert-error {
        background: #fff5f5;
        border-color: #feb2b2;
        color: #c53030;
    }

    #progress-bar {
        transition: width 0.3s ease;
    }
</style>

<!-- Scripts -->
<script>
    const downloadId = new URLSearchParams(window.location.search).get('id');
    const startTime = Date.now();
    let lastUpdate = 0;
    let totalSize = 0;

    // Initialize download progress tracking
    function initializeDownload() {
        if (!downloadId) {
            showError('No download ID provided');
            return;
        }

        // Get initial status
        fetch(`/api/download-status/${downloadId}`)
            .then(r => r.json())
            .then(data => {
                updateUI(data);
            })
            .catch(err => console.error('Status fetch error:', err));

        // Connect to SSE stream
        connectProgressStream();
    }

    // Connect to Server-Sent Events stream
    function connectProgressStream() {
        const eventSource = new EventSource(`/api/download-progress/${downloadId}`);

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                updateUI(data);

                // Stop listening on completion
                if (data.status === 'completed' || data.status === 'error') {
                    eventSource.close();
                }
            } catch (e) {
                console.error('Parse error:', e);
            }
        };

        eventSource.onerror = function() {
            eventSource.close();
            showError('Connection to server lost. Retrying...');
            setTimeout(connectProgressStream, 3000);
        };
    }

    // Update UI with progress data
    function updateUI(data) {
        // Update progress bar
        const progress = Math.min(data.progress || 0, 100);
        document.getElementById('progress-bar').style.width = progress + '%';
        document.getElementById('progress-bar').setAttribute('aria-valuenow', progress);
        document.getElementById('progress-percent').textContent = Math.round(progress) + '%';

        // Update status
        const status = data.status || 'unknown';
        document.getElementById('download-status').textContent = capitalizeFirst(status);
        document.getElementById('status-text').textContent = getStatusMessage(status);

        // Update statistics
        const files = data.files || [];
        document.getElementById('file-count').textContent = files.length;

        const size = (data.total_size || 0) / (1024 * 1024);
        document.getElementById('downloaded-size').textContent = size.toFixed(1) + ' MB';

        // Calculate speed
        const elapsed = (Date.now() - startTime) / 1000;
        if (elapsed > 0 && data.total_size) {
            const speed = (data.total_size / (1024 * 1024)) / (elapsed / 3600);
            document.getElementById('download-speed').textContent = speed.toFixed(1) + ' MB/h';
        }

        // Show errors
        if (data.errors && data.errors.length > 0) {
            showErrors(data.errors);
        }

        // Show storage options on completion
        if (status === 'completed') {
            document.getElementById('loading-spinner').classList.add('d-none');
            document.getElementById('storage-options').classList.remove('d-none');

            // Set default option
            document.getElementById('analyze-opt').checked = true;
        }
    }

    // Get user-friendly status message
    function getStatusMessage(status) {
        const messages = {
            'downloading': '‚è≥ Downloading imagery...',
            'completed': '‚úÖ Download completed successfully',
            'error': '‚ùå Download encountered an error',
            'failed': '‚ùå Download failed',
            'initializing': 'üîÑ Initializing download...'
        };
        return messages[status] || '‚è≥ Processing...';
    }

    // Show errors
    function showErrors(errors) {
        const container = document.getElementById('errors-container');
        if (errors.length === 0) return;

        const alertHtml = `
            <div class="alert alert-error alert-dismissible fade show" role="alert">
                <strong>‚ö†Ô∏è Errors Occurred:</strong>
                <ul class="mb-0 mt-2">
                    ${errors.map(e => `<li>${e}</li>`).join('')}
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        container.innerHTML = alertHtml;
    }

    // Show single error
    function showError(msg) {
        document.getElementById('errors-container').innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show">
                <strong>Error:</strong> ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    // Select storage option
    function selectStorage(action) {
        document.getElementById(`${action}-opt`).checked = true;
    }

    // Confirm storage decision
    function confirmStorage() {
        const action = document.querySelector('input[name="storage"]:checked')?.value;
        const autoAnalyze = document.getElementById('auto-analyze-check').checked;

        if (!action) {
            alert('Please select a storage option');
            return;
        }

        // Disable button
        const btn = document.getElementById('confirm-storage-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

        // Send confirmation
        fetch(`/api/confirm-storage/${downloadId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, auto_analyze: autoAnalyze })
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                btn.disabled = false;
                btn.textContent = 'Confirm & Continue';
            } else {
                // Redirect based on action
                if (autoAnalyze && data.analysis_id) {
                    window.location.href = `/analysis/${data.analysis_id}`;
                } else {
                    alert('Storage confirmed. Imagery ' + action + ' successfully.');
                    window.location.href = '/';
                }
            }
        })
        .catch(err => {
            showError('Failed to confirm storage: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Confirm & Continue';
        });
    }

    // Go home
    function goHome() {
        window.location.href = '/';
    }

    // Helper functions
    function capitalizeFirst(str) {
        return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializeDownload);
</script>
{% endblock %}
